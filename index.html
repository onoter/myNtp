<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyIn8finity</title>
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="manifest.json">
    <!-- Local Icon -->
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon.svg">
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 800: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>
    <!-- Lucide Icons (CDN) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* 自定义滚动条 */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        /* 禁用点击高亮 */
        * { -webkit-tap-highlight-color: transparent; }
        /* 动画 */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-900 text-white h-screen w-screen overflow-hidden flex flex-col max-w-md mx-auto border-x border-slate-800 shadow-2xl relative">

    <!-- 顶部栏 -->
    <div class="p-6 pb-2 flex-none z-10">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                MyInfinity
            </h1>
            <button onclick="openSettings()" class="p-2 text-slate-400 hover:text-white bg-slate-800 rounded-full active:scale-95 transition-transform">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- 搜索框 -->
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i data-lucide="search" class="w-4 h-4 text-slate-500"></i>
            </div>
            <input 
                type="text" 
                id="searchInput"
                oninput="renderBookmarks()"
                placeholder="搜索..." 
                class="w-full bg-slate-800/50 border border-slate-700 rounded-xl py-3 pl-10 pr-4 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 placeholder:text-slate-600 transition-all"
            >
        </div>
    </div>

    <!-- 书签网格区域 -->
    <div class="flex-1 overflow-y-auto p-6 pt-2" id="gridContainer">
        <!-- JS 会在这里插入内容 -->
    </div>

    <!-- 添加/编辑 弹窗 -->
    <div id="bookmarkModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
        <div class="bg-slate-800 border border-slate-700 w-full max-w-sm rounded-2xl shadow-2xl flex flex-col animate-fadeIn">
            <div class="flex items-center justify-between p-4 border-b border-slate-700">
                <h3 id="modalTitle" class="text-lg font-semibold">添加书签</h3>
                <button onclick="closeModal('bookmarkModal')" class="p-1 text-slate-400"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form onsubmit="handleSave(event)" class="p-4 space-y-4">
                <input type="hidden" id="editId">
                <div>
                    <label class="text-xs text-slate-400 ml-1">网址</label>
                    <input type="text" id="inpUrl" required placeholder="example.com" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-3 text-white text-sm focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-slate-400 ml-1">标题</label>
                    <input type="text" id="inpTitle" required placeholder="网站名称" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-3 text-white text-sm focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs text-slate-400 ml-1">颜色</label>
                    <div class="flex items-center gap-3">
                        <input type="color" id="inpColor" value="#3b82f6" class="w-10 h-10 rounded bg-transparent border-0 cursor-pointer">
                        <span class="text-xs text-slate-500">点击色块选择光晕颜色</span>
                    </div>
                </div>
                <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-medium rounded-xl shadow-lg mt-2 active:scale-95 transition-transform">保存</button>
                <button type="button" id="btnDelete" onclick="handleDelete()" class="hidden w-full py-3 bg-red-900/30 text-red-400 font-medium rounded-xl border border-red-900/50 active:scale-95 transition-transform">删除此书签</button>
            </form>
        </div>
    </div>

    <!-- 设置 弹窗 -->
    <div id="settingsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
        <div class="bg-slate-800 border border-slate-700 w-full max-w-sm rounded-2xl shadow-2xl animate-fadeIn">
            <div class="flex items-center justify-between p-4 border-b border-slate-700">
                <h3 class="text-lg font-semibold">数据备份</h3>
                <button onclick="closeModal('settingsModal')" class="p-1 text-slate-400"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-xs text-slate-500 mb-4">数据仅存储在您的设备中。建议定期导出备份。</p>
                <button onclick="exportData()" class="w-full flex items-center justify-center gap-2 bg-slate-700 py-3 rounded-xl hover:bg-slate-600 active:scale-95 transition-transform text-sm font-medium">
                    <i data-lucide="download" class="w-4 h-4"></i> 导出备份 (JSON)
                </button>
                <label class="w-full flex items-center justify-center gap-2 bg-slate-700 py-3 rounded-xl hover:bg-slate-600 active:scale-95 transition-transform cursor-pointer text-sm font-medium">
                    <i data-lucide="upload" class="w-4 h-4"></i> 导入备份
                    <input type="file" accept=".json" onchange="importData(this)" class="hidden">
                </label>
                <p class="text-center text-xs text-slate-600 pt-4">v1.5 PWA • 离线可用</p>
            </div>
        </div>
    </div>

    <script>
        // --- 核心逻辑 ---
        const DEFAULT_BOOKMARKS = [
            { id: '1', title: 'Google', url: 'https://google.com', color: '#4285F4' },
            { id: '2', title: 'GitHub', url: 'https://github.com', color: '#ffffff' },
            { id: '3', title: 'Bilibili', url: 'https://bilibili.com', color: '#FB7299' },
        ];

        let bookmarks = [];

        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            const stored = localStorage.getItem('myinfinity_bookmarks');
            if (stored) {
                try { bookmarks = JSON.parse(stored); } catch(e) { bookmarks = DEFAULT_BOOKMARKS; }
            } else {
                bookmarks = DEFAULT_BOOKMARKS;
            }
            renderBookmarks();
            
            // 注册 Service Worker
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js')
                        .then(reg => console.log('SW Registered', reg))
                        .catch(err => console.log('SW Fail:', err));
                });
            }
        });

        // 保存到本地
        function save() {
            localStorage.setItem('myinfinity_bookmarks', JSON.stringify(bookmarks));
            renderBookmarks();
        }

        // 渲染界面
        function renderBookmarks() {
            const container = document.getElementById('gridContainer');
            const query = document.getElementById('searchInput').value.toLowerCase();
            
            const filtered = bookmarks.filter(b => 
                b.title.toLowerCase().includes(query) || b.url.toLowerCase().includes(query)
            );

            let html = '<div class="grid grid-cols-4 gap-4">';
            
            filtered.forEach(b => {
                const domain = new URL(b.url).hostname;
                const favicon = `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
                
                html += `
                <div class="flex flex-col items-center gap-2 group relative">
                    <div onclick="window.location.href='${b.url}'" 
                         class="w-full aspect-square bg-slate-800/80 rounded-2xl flex items-center justify-center p-3 cursor-pointer shadow-lg active:scale-90 transition-all border border-slate-700/50 relative overflow-hidden"
                         style="box-shadow: 0 4px 15px -5px ${b.color}40;">
                         
                         <img src="${favicon}" 
                              class="w-8 h-8 object-contain z-10 rounded-md" 
                              onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                         <span class="text-xl font-bold hidden text-slate-300" style="display:none">${b.title.charAt(0).toUpperCase()}</span>
                         
                         <button onclick="event.stopPropagation(); openEdit('${b.id}')" class="absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white/50 hover:text-white z-20">
                            <i data-lucide="more-horizontal" class="w-3 h-3"></i>
                         </button>
                    </div>
                    <span class="text-xs text-slate-300 truncate w-full text-center px-1">${b.title}</span>
                </div>
                `;
            });

            // 添加按钮
            html += `
                <div onclick="openAdd()" class="aspect-square rounded-2xl border-2 border-dashed border-slate-700 flex flex-col items-center justify-center text-slate-500 active:scale-95 transition-transform cursor-pointer hover:border-slate-500 hover:text-slate-300">
                    <i data-lucide="plus" class="w-6 h-6 mb-1"></i>
                    <span class="text-[10px]">添加</span>
                </div>
            `;
            
            html += '</div>';
            
            if (filtered.length === 0) {
                html += '<div class="text-center text-slate-500 mt-10 text-sm">暂无书签</div>';
            }

            container.innerHTML = html;
            
            // 重新渲染图标
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        // --- 弹窗与交互 ---
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function openAdd() {
            document.getElementById('editId').value = '';
            document.getElementById('inpUrl').value = '';
            document.getElementById('inpTitle').value = '';
            document.getElementById('inpColor').value = '#3b82f6';
            document.getElementById('modalTitle').innerText = '添加书签';
            document.getElementById('btnDelete').classList.add('hidden');
            openModal('bookmarkModal');
        }

        function openSettings() { openModal('settingsModal'); }

        function openEdit(id) {
            const b = bookmarks.find(x => x.id === id);
            if (!b) return;
            document.getElementById('editId').value = id;
            document.getElementById('inpUrl').value = b.url;
            document.getElementById('inpTitle').value = b.title;
            document.getElementById('inpColor').value = b.color;
            document.getElementById('modalTitle').innerText = '编辑书签';
            document.getElementById('btnDelete').classList.remove('hidden');
            openModal('bookmarkModal');
        }

        function handleSave(e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            let url = document.getElementById('inpUrl').value;
            const title = document.getElementById('inpTitle').value;
            const color = document.getElementById('inpColor').value;

            if (!url.startsWith('http')) url = 'https://' + url;

            if (id) {
                const idx = bookmarks.findIndex(x => x.id === id);
                if (idx !== -1) {
                    bookmarks[idx] = { ...bookmarks[idx], url, title, color };
                }
            } else {
                bookmarks.push({
                    id: Date.now().toString(),
                    url, title, color
                });
            }
            save();
            closeModal('bookmarkModal');
        }

        function handleDelete() {
            const id = document.getElementById('editId').value;
            if (confirm('删除此书签？')) {
                bookmarks = bookmarks.filter(b => b.id !== id);
                save();
                closeModal('bookmarkModal');
            }
        }

        // --- 数据导入导出 ---
        function exportData() {
            const dataStr = JSON.stringify(bookmarks, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `myinfinity_backup.json`;
            link.click();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) {
                        if(confirm('导入将覆盖当前数据？')) {
                            bookmarks = json;
                            save();
                            closeModal('settingsModal');
                        }
                    } else { alert('格式错误'); }
                } catch(err) { alert('文件损坏'); }
            };
            reader.readAsText(file);
        }
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
